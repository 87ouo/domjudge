{% set pageTitle = 'Submission s' ~ submission.submitid %}
{% set noPageHeader = true %}

{% extends '@DOMjudgeJury/base.html.twig' %}

{% block body %}
	{% if submission.originalSubmission is not null %}
		{% set link = path('jury_submission', {'submissionId': submission.originalSubmission.submitid}) %}
		{% set extra = ' (resubmit of <a href="' ~ link ~ '">s' ~ submission.originalSubmission.submitid ~ '</a>)' %}
		{% set pageHeader = pageTitle ~ extra %}
	{% else %}
		{% set pageHeader = pageTitle %}
	{% endif %}
	{% if not submission.valid %}
		{% set pageHeader = pageHeader ~ ' (ignored)' %}
	{% endif %}
	<br/>
	<h1 style="display: inline;">{{ pageHeader | raw }}</h1>
	{% if is_granted('ROLE_ADMIN') %}
		&nbsp;
		{% if submission.valid %}
			{% set ignore = 'ignore' %}
		{% else %}
			{% set ignore = 'unignore' %}
		{% endif %}
		{% set confirmText = 'Really ' ~ ignore ~ ' submission s' ~ submission.submitid ~ '?' %}
		{{ form_start(ignoreForm, {'attr': {
			'style': 'display: inline;',
			'onclick': 'return confirm("' ~ confirmText ~ '");'
		}}) }}
		{{ form_widget(ignoreForm.submit) }}
		{{ form_end(ignoreForm) }}
	{% endif %}
	
	{% if not submission.valid %}
		<p>This submission is not used during scoreboard calculations.</p>
	{% endif %}
	
	{# Condensed submission info on a single line with icons #}
	<p>
		<img title="team" alt="Team:" src="{{ asset('bundles/domjudgemain/images/team.png') }}"/>
		<a href="#">{{ submission.team.name ~ ' (t' ~ submission.team.teamid ~ ')' }}</a>
		&nbsp;&nbsp;
		<img title="contest" alt="Contest:" src="{{ asset('bundles/domjudgemain/images/contest.png') }}"/>
		<a href="#">
			<span class="contestid">{{ submission.contest.shortName }}</span>
		</a>
		&nbsp;&nbsp;
		<img title="problem" alt="Problem:" src="{{ asset('bundles/domjudgemain/images/problem.png') }}"/>
		<a href="#">
			<span class="probid">{{ submission.contestProblem.shortName }}</span>:
			{{ submission.problem.name }}
		</a>
		&nbsp;&nbsp;
		<img title="language" alt="Language:" src="{{ asset('bundles/domjudgemain/images/lang.png') }}"/>
		<a href="#">
			{{ submission.language.name }}
		</a>
		&nbsp;&nbsp;
		<img title="submittime" alt="Submittime:" src="{{ asset('bundles/domjudgemain/images/submittime.png') }}"/>
		<span title="{{ submission.submitTime | formatTime('%Y-%m-%d %H:%M:%S (%Z)') }}">
			{{ submission.submitTime | formatTime }}
		</span>
		&nbsp;&nbsp;
		<img title="allowed runtime" alt="Allowed runtime:" src="{{ asset('bundles/domjudgemain/images/allowedtime.png') }}"/>
		{{ (submission.language.timeFactor * submission.problem.timeLimit) | round(0, 'ceil') }}s
		&nbsp;&nbsp;
		<img title="view source code" alt="" src="{{ asset('bundles/domjudgemain/images/code.png') }}"/>
		<a href="#" style="font-weight:bold;">view source code</a>
	</p>
	
	{% if judgings | length > 1 or (judgings is not empty and currentJudging is null) %}
		<table class="list">
			<caption>Judgings</caption>
			<thead>
			<tr>
				<td></td>
				<th scope="col">ID</th>
				<th scope="col">start</th>
				<th scope="col">max runtime</th>
				<th scope="col">judgehost</th>
				<th scope="col">result</th>
				<th scope="col">rejudging</th>
			</tr>
			</thead>
			<tbody>
			{% for judgingData in judgings %}
				{% set maxRunTime = judgingData.maxRunTime %}
				{# @var judging \DOMjudge\MainBundle\Entity\Judging #}
				{% set judging = judgingData.0 %}
				<tr {% if not judging.valid %}class="disabled"{% endif %}>
					{% set link = path('jury_submission', {'submissionId': submission.submitid, 'judging': judging.judgingid}) %}
					<td>
						<a href="{{ link }}">
							{% if judging.judgingid == currentJudging.judgingid %}&rarr;{% endif %}
							&nbsp;
						</a>
					</td>
					<td><a href="{{ link }}">j{{ judging.judgingid }}</a></td>
					<td><a href="{{ link }}">{{ judging.startTime | formatTime }}</a></td>
					<td><a href="{{ link }}">{{ maxRunTime }} s</a></td>
					<td><a href="{{ link }}">{% if judging.judgehost is not null %}{{ judging.judgehost.hostname | formatHost }}{% endif %}</span></a></td>
					<td><a href="{{ link }}">{{ judging.result | formatResult(true, judging.valid) }}</a></td>
					<td>
						<a href="{{ link }}">
							{% if judging.rejudging is not null %}
								r{{ judging.rejudging.rejudgingid }} ({{ judging.rejudging.reason }})
							{% endif %}
						</a>
					</td>
				</tr>
			{% endfor %}
			</tbody>
		</table>
	{% endif %}
	
	{% if currentJudging is null %}
		<p><em>Not (re)judged yet</em></p>
		
		{# TODO: restriction checking. Idea: modify Entity/Judgehost to have a function 'canJudgeSubmission' #}
	{% else %}
		{# TODO: rejudge form #}
		<br/>
		<h2 style="display: inline;">
			Judging j{{ currentJudging.judgingid }}
			{% if currentJudging.rejudging is not null %}
				(rejudging <a href="#">r{{ currentJudging.rejudging.rejudgingid }}</a>, reason: {{ currentJudging.rejudging.reason }})
			{% elseif not currentJudging.valid %}
				(INVALID)
			{% endif %}
		</h2>
		&nbsp;
		{# TODO: add verify / claim form #}
		<br /><br />
		Result: {{ currentJudging.result | formatResult(true, currentJudging.valid) }}
		{%- if lastJudging is not null -%}
			<span class="lastresult"> (<a href="{{ path('jury_submission', {'submissionId': lastSubmission.submitid}) }}">s{{ lastSubmission.submitid }}</a>: {{ lastJudging.result }})</span>,
		{%- else -%}
			,
		{%- endif %}
		Judgehost: <a href="#">{% if currentJudging.judgehost is not null %}{{ currentJudging.judgehost.hostname | formatHost }}{% endif %}</a>
		
		{# Time (start, end, used) #}
		<span class="judgetime">
			Judging started: {{ currentJudging.startTime | formatTime('%H:%M:%S') }}
			{%- if currentJudging.endTime is not empty -%}
				, finished in {{ formatTimeDiff(currentJudging.startTime, currentJudging.endTime) }} s
			{%- elseif currentJudging.valid or currentJudging.rejudging is not null -%}
				&nbsp;[still judging - busy {{ formatTimeDiff(currentJudging.startTime) }}]
			{%- else -%}
				&nbsp;[aborted]
			{%- endif -%}
		</span>
		
		{% if currentJudging.result != 'compiler-error' %}
			, max/sum runtime: {{ '%.2f/%.2fs' | format(maxRunTime, sumRunTime) }}
			
			{% if lastRuns is not null -%}
				<span class="lastruntime">
					(<a href="{{ path('jury_submission', {'submissionId': lastSubmission.submitid}) }}">s{{ lastSubmission.submitid }}</a>:
					{{ '%.2f/%.2fs' | format(maxLastRunTime, sumLastRunTime) }})
				</span>
			{%- endif %}
			
			<table>
				<tr>
					<td>testcase runs:</td>
					<td>
						{% spaceless %}
						{% for testCaseData in testCases %}
							{# @var testCase \DOMjudge\MainBundle\Entity\TestCase #}
							{% set testCase = testCaseData.0 %}
							{% set judgingRun = null %}
							{% if runs[testCase.testcaseid] is defined %}
								{% set judgingRun = runs[testCase.testcaseid].0 %}
							{% endif %}
							{{ testcaseRun(testCase, judgingRun, currentJudging.endTime is not empty) }}
						{% endfor %}
						{% endspaceless %}
					</td>
				</tr>
				{% if lastRuns is not null %}
					<tr class="lasttcruns">
						<td>
							<a href="{{ path('jury_submission', {'submissionId': lastSubmission.submitid}) }}">s{{ lastSubmission.submitid }}</a> runs:
						</td>
						<td>
							{% spaceless %}
								{% for testCaseData in testCases %}
									{# @var testCase \DOMjudge\MainBundle\Entity\TestCase #}
									{% set testCase = testCaseData.0 %}
									{% set judgingRun = null %}
									{% if lastRuns[testCase.testcaseid] is defined %}
										{% set judgingRun = lastRuns[testCase.testcaseid] %}
									{% endif %}
									{{ testcaseRun(testCase, judgingRun, lastJudging.endTime is not empty) }}
								{% endfor %}
							{% endspaceless %}
						</td>
					</tr>
				{% endif %}
			</table>
		{% endif %}
		
		{# Show JS toggle of previous submission results. #}
		{% if lastJudging is not null %}
			<span class="testcases_prev">
				<a href="javascript:togglelastruns();">show/hide</a>
				results of previous
				<a href="{{ path('jury_submission', {'submissionId': lastSubmission.submitid}) }}">submission s{{ lastSubmission.submitid }}</a>
				{% if lastJudging.verifyComment is not empty %}
					<span class="prevsubmit"> (verify comment: {{ lastJudging.verifyComment }})</span>
				{% endif %}
			</span>
		{% endif %}
		
		{#
		Display following data only when the judging result is known.
		Note that the judging may still not be finished yet when lazy
		evaluation is off
		#}
		{% if currentJudging.result is not empty %}
			{# display verification data: verified, by whom, and comment. #}
			{# only if this is a valid judging, otherwise irrelevant #}
			{% if currentJudging.valid or (currentJudging.rejudging is not null and currentJudging.rejudging.valid) %}
				{# TODO verification data and form #}
			{% endif %}
		{% else %}
			<p><b>Judging is not ready yet!</b></p>
		{% endif %}

		<script type="text/javascript">
			togglelastruns();
		</script>
		
		{# Display compilation output #}
		{% set compileColor = '#6666FF' %}
		{% set compileMessage = 'not finished yet' %}
		{% if currentJudging.outputCompile is not null %}
			{% if currentJudging.result != "compiler-error" %}
				{% set compileColor = '#1daa1d' %}
				{% set compileMessage = 'successful' %}
				{% if currentJudging.outputCompileString is not empty %}
					{% set compileMessage = compileMessage ~ ' (with ' ~ currentJudging.outputCompileLines ~ ' line(s) of output)' %}
				{% endif %}
			{% else %}
				{% set compileColor = 'red' %}
				{% set compileMessage = 'unsuccessful' %}
			{% endif %}
		{% endif %}
		
		<h3 id="compile">
			{% if currentJudging.outputCompileString is not empty %}
				<a class="collapse" href="javascript:collapse('compile')">
			{% endif %}
					Compilation <span style="color: {{ compileColor }};">{{ compileMessage }}</span>
			{% if currentJudging.outputCompileString is not empty %}
				</a>
			{% endif %}
		</h3>
		
		{% if currentJudging.outputCompileString is not empty %}
			<pre class="output_text" id="detailcompile">{{ currentJudging.outputCompileString }}</pre>
		{% else %}
			<p class="nodata" id="detailcompile">There were no compiler errors or warnings.</p>
		{% endif %}
		
		{# Collapse compile output when compiled succesfully #}
		<script type="text/javascript">
			collapse('compile');
		</script>
		
		{# If compilation is not finished yet or failed, there's no more info to show, so stop here #}
		{% if currentJudging.outputCompileString is null or currentJudging.result == 'compiler-error' %}
			{# stop #}
		{% else %}
			{% for testCaseData in testCases %}
				{# @var testCase \DOMjudge\MainBundle\Entity\TestCase #}
				{% set testCase = testCaseData.0 %}
				{# @var judgingRun \DOMjudge\MainBundle\Entity\JudgingRun #}
				{% set judgingRun = null %}
				{% if runs[testCase.testcaseid] is defined %}
					{% set judgingRun = runs[testCase.testcaseid].0 %}
				{% endif %}

				{% if judgingRun is not null and judgingRun.runResult == 'correct' %}
					<div class="run_correct">
				{% endif %}

				<h4 id="run-{{ testCase.rank }}">Run {{ testCase.rank }}</h4>

				{% if judgingRun is null or judgingRun.runResult is null %}
					<p class="nodata">
						{% if currentJudging.result is null %}
							Run not started/finished yet.
						{% else %}
							Run not used for final result.
						{% endif %}
					</p>
				{% else %}
					{% set judgingData = runs[testCase.testcaseid] %}
					
					{% set timelimitStr = '' %}
					{% if judgingRun.runResult == 'timelimit' %}
						{% if judgingData.outputSystem matches '/timelimit exceeded.*hard (wall|cpu) time/' %}
							{% set timelimitStr = '<b>(terminated)</b>' %}
						{% else %}
							{% set timelimitStr = '<b>(finished late)</b>' %}
						{% endif %}
					{% endif %}
					
					<table>
						<tr>
							<td>
								
								<table>
									<tr>
										<td>Description:</td>
										<td>{{ testCase.description }}</td>
									</tr>
									<tr>
										<td>Download:</td>
										<td>
											<a href="#">Input</a>
											/
											<a href="#">Reference Output</a>
											/
											<a href="#">Team Output</a>
										</td>
									</tr>
									<tr>
										<td>Runtime:</td>
										<td>
											{{ judgingRun.runTime }} sec {{ timelimitStr | raw }}
										</td>
									</tr>
									<tr>
										<td>Result:</td>
										<td>
											<span class="sol sol_{% if judgingRun.runResult != 'correct' %}in{% endif %}correct">
												{{ judgingRun.runResult }}
											</span>
										</td>
									</tr>
								</table>
								
							</td>
							<td>
								{# TODO: testcase image display #}
							</td>
						</tr>
					</table>
					
					<h5>Diff output</h5>
					
					{% if judgingData.outputDiff | length > 0 %}
						<pre class="output_text">{{ parseRunDiff(truncateCheck(judgingData.outputDiff)) }}</pre>
					{% else %}
						<p class="nodata">There was no diff output.</p>
					{% endif %}
					
					{% if judgingRun.runResult != 'correct' %}
						{{ formatRunOutputText(judgingData.outputRun, testCaseData.outputReference) }}
					{% endif %}

					<h5>Program output</h5>
					{% if judgingData.outputRun is not empty %}
						<pre class="output_text">{{ truncateCheck(judgingData.outputRun) }}</pre>
					{% else %}
						<p class="nodata">There was no program output.</p>
					{% endif %}

					<h5>Program error output</h5>
					{% if judgingData.outputError is not empty %}
						<pre class="output_text">{{ truncateCheck(judgingData.outputError) }}</pre>
					{% else %}
						<p class="nodata">There was no program stderr output.</p>
					{% endif %}

					<h5>Judging system output (info/debug/errors)</h5>
					{% if judgingData.outputSystem is not empty %}
						<pre class="output_text">{{ truncateCheck(judgingData.outputSystem) }}</pre>
					{% else %}
						<p class="nodata">There was no judging system output.</p>
					{% endif %}
				{% endif %}

				{% if judgingRun is not null and judgingRun.runResult == 'correct' %}
					</div>
				{% endif %}
			{% endfor %}

			<script type="text/javascript">
				function display_correctruns(show) {
					var elements = document.getElementsByClassName('run_correct');
					for (i = 0; i < elements.length; i++) {
						elements[i].style.display = show ? 'block' : 'none';
					}
				}
				display_correctruns(false);
			</script>
		{% endif %}
	{% endif %}
{% endblock %}

