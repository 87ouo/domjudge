ifndef TOPDIR
TOPDIR=..
endif
include $(TOPDIR)/Makefile.global

EXECDIRS=$(shell find files -mindepth 2 -maxdepth 2 -type d)
ZIPFILES=$(EXECDIRS:=.zip)
ZIPSQL=mysql_db_files_defaultdata.sql mysql_db_files_examples.sql

config: dj-setup-database $(ZIPSQL)

# Use secondary expansion to use stem $* in dependencies:
.SECONDEXPANSION:
$(ZIPFILES): %.zip: $$(wildcard $$*/*)
	@rm -f $@
	zip -qjr $@ $*

$(ZIPSQL:=.in): $(ZIPFILES)
	rm -f $@
	@echo "\
-- @configure_input@\n\
-- Generated by 'make dist' on `date`\n" >> mysql_db_files_defaultdata.sql.in
	cp mysql_db_files_defaultdata.sql.in mysql_db_files_examples.sql.in
	for i in files/defaultdata/*.zip ; do \
		echo "UPDATE executable SET zipfile = LOAD_FILE('@domserver_sqldir@/$$i'), md5sum = '`md5sum $$i | cut -f1 -d\\ `' WHERE execid = '`basename $$i .zip`';" >> mysql_db_files_defaultdata.sql.in ; \
	done
	for i in files/examples/*.zip ; do \
		echo "UPDATE executable SET zipfile = LOAD_FILE('@domserver_sqldir@/$$i'), md5sum = '`md5sum $$i | cut -f1 -d\\ `' WHERE execid = '`basename $$i .zip`';" >> mysql_db_files_examples.sql.in ; \
	done

$(ZIPSQL): %: %.in $(TOPDIR)/paths.mk
	$(substconfigvars)

dj-setup-database: %: %.in $(TOPDIR)/paths.mk
	$(substconfigvars)
	chmod a+x $@

install-domserver:
	$(INSTALL_PROG) -t $(DESTDIR)$(domserver_bindir) dj-setup-database
	$(INSTALL_DATA) -t $(DESTDIR)$(domserver_sqldir) \
		mysql_db_structure.sql mysql_db_defaultdata.sql mysql_db_examples.sql \
		$(ZIPSQL)
	$(INSTALL_DATA) -t $(DESTDIR)$(domserver_sqldir)/upgrade \
	 	upgrade/upgrade_*.sql upgrade/README
	$(INSTALL_DATA) -t $(DESTDIR)$(domserver_sqldir)/files/defaultdata \
	 	files/defaultdata/*.zip
	$(INSTALL_DATA) -t $(DESTDIR)$(domserver_sqldir)/files/examples \
	 	files/examples/*.zip

distclean-l:
	-rm -f dj-setup-database $(ZIPSQL:=.in) $(ZIPSQL) $(ZIPFILES)

dist-l: $(ZIPSQL:=.in) $(ZIPFILES)
